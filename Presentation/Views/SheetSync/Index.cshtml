@{
    Layout = "_Layout";
    var cfg = (Dictionary<string, string>)Model;
    string Value(string k) => cfg.TryGetValue(k, out var v) ? v : "";
}

<h3>External Google-Sheet links</h3>

<table class="table" id="sheetTable">
    <thead><tr><th>Table</th><th style="width:60%">URL</th><th></th></tr></thead>
    <tbody>
        @foreach (var key in new[] { "interview", "ap", "onboarding", "todo" })
        {
            <tr data-key="@key">
                <td class="text-capitalize">@key</td>
                <td>
                    <input class="form-control" disabled value="@Value(key)">
                </td>
                <td class="text-nowrap">
                    <button class="btn btn-sm btn-outline-secondary edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success save d-none">
                        <i class="bi bi-check-lg"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger cancel d-none">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<button class="btn btn-primary" id="syncAll">
    <i class="bi bi-cloud-arrow-down"></i> Sync
</button>

@section Scripts
{
    <script>
        const api = "https://localhost:7016/";

        document.querySelectorAll("#sheetTable tr").forEach(row => {
          const input   = row.querySelector("input");
          const editBtn = row.querySelector(".edit");
          const saveBtn = row.querySelector(".save");
          const cancelBtn = row.querySelector(".cancel");
          let original = input.value;

          editBtn.onclick = () => {
              input.disabled = false;
              input.focus();
              toggle(true);
          };
          cancelBtn.onclick = () => {
              input.value = original;
              input.disabled = true;
              toggle(false);
          };
          saveBtn.onclick = async () => {
              const key = row.dataset.key;
              const body = {[key]: input.value};
              await fetch(api+"api/sheets/config", {
                  method:"PUT", headers:{'Content-Type':'application/json'},
                  body: JSON.stringify(body), credentials:"include"});
              original = input.value;
              input.disabled = true;
              toggle(false);
          };
          function toggle(editing){
              editBtn.classList.toggle("d-none", editing);
              saveBtn.classList.toggle("d-none", !editing);
              cancelBtn.classList.toggle("d-none", !editing);
          }
        });

        document.getElementById("syncAll").onclick = async () => {
            const res = await fetch(api+"api/sheets/sync",
                        {method:"POST", credentials:"include"});
            alert(await res.text());
        };
    </script>
}
